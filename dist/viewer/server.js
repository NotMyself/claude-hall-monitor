// @bun
var Z0=import.meta.require;import{join as W,resolve as C}from"path";var G={PORT:parseInt(process.env.HOOK_VIEWER_PORT||"3456",10),HOST:process.env.HOOK_VIEWER_HOST||"127.0.0.1",get URL(){return`http://${this.HOST}:${this.PORT}`}},Y={VIEWER_DIR:import.meta.dir,LOGS_DIR:C(import.meta.dir,"..","logs"),getSessionLogPath(M){return W(this.LOGS_DIR,`${M}.txt`)},INDEX_HTML:W(import.meta.dir,"index.html"),STYLES_DIR:W(import.meta.dir,"styles"),LOGO_SVG:W(import.meta.dir,"logo.svg"),CLAUDE_HOME:process.env.USERPROFILE?W(process.env.USERPROFILE,".claude"):W(process.env.HOME||"",".claude"),get STATS_CACHE(){return W(this.CLAUDE_HOME,"stats-cache.json")},COMMANDS_DIR:C(import.meta.dir,"..","..","commands"),SKILLS_DIR:C(import.meta.dir,"..","..",".claude","skills"),SETTINGS_FILE:C(import.meta.dir,"..","..",".claude","settings.json"),PROJECT_ROOT:C(import.meta.dir,"..",".."),get DEV_ACTIVE_DIR(){return W(this.PROJECT_ROOT,"dev","active")},get DEV_COMPLETE_DIR(){return W(this.PROJECT_ROOT,"dev","complete")},getPlanFeaturesPath(M){return W(M,"features.json")}},I="CLAUDE_HOOKS_VIEWER_SESSION",N={HEARTBEAT_INTERVAL:30000,RECONNECT_DELAY:3000},d={POLL_INTERVAL:500},l={HEARTBEAT_TIMEOUT_MS:60000,HEARTBEAT_INTERVAL_MS:30000,REFRESH_INTERVAL_MS:5000},c={SHUTDOWN_DELAY_MS:100,DASHBOARD_POLL_INTERVAL_MS:5000,FILE_WATCH_INTERVAL_MS:500,SSE_HEARTBEAT_INTERVAL_MS:30000},j={POLL_INTERVAL_MS:1000,MAX_COMPLETED_PLANS:10};import{existsSync as $0,readdirSync as K0,statSync as Y0,readFileSync as B0}from"fs";import{join as U0}from"path";class R{lastSize=0;interval=null;subscribers=new Set;currentSessionId=null;start(){if(this.interval)return;this.lastSize=this.getFileSize(),this.interval=setInterval(()=>{this.checkForChanges()},d.POLL_INTERVAL)}stop(){if(this.interval)clearInterval(this.interval),this.interval=null}subscribe(M){return this.subscribers.add(M),()=>this.subscribers.delete(M)}setSession(M){this.currentSessionId=M,this.lastSize=this.getFileSize()}getCurrentSessionId(){return this.currentSessionId}getAllEntries(){let M=this.getLogFilePath();if(!M)return[];try{if(!Bun.file(M).size)return[];let J=B0(M,"utf-8");return this.parseLines(J)}catch(w){return console.error("Failed to read log file:",w),[]}}static async listSessions(){let M=Y.LOGS_DIR;if(!$0(M))return[];let w=K0(M).filter((Q)=>Q.endsWith(".txt")&&Q!==".gitkeep");return(await Promise.all(w.map(async(Q)=>{let X=Q.replace(".txt",""),Z=U0(M,Q),$=Y0(Z),B=(await Bun.file(Z).text()).trim().split(`
`).filter(Boolean),U="",V="";if(B.length>0)try{let L=B[0],F=B[B.length-1];if(L&&F){let D=JSON.parse(L),k=JSON.parse(F);U=D.timestamp??"",V=k.timestamp??""}}catch(L){console.error("Failed to parse session timestamps:",L)}return{session_id:X,file_path:Z,first_entry:U,last_entry:V,entry_count:B.length,size_bytes:$.size}}))).sort((Q,X)=>X.last_entry.localeCompare(Q.last_entry))}getLogFilePath(){if(!this.currentSessionId)return null;return Y.getSessionLogPath(this.currentSessionId)}getFileSize(){let M=this.getLogFilePath();if(!M)return 0;try{return Bun.file(M).size}catch(w){return console.error("Failed to get file size:",w),0}}checkForChanges(){let M=this.getFileSize();if(M>this.lastSize){let w=this.getLogFilePath();if(!w)return;try{Bun.file(w).slice(this.lastSize,M).text().then((X)=>{let Z=this.parseLines(X);for(let $ of Z)this.emit($)}).catch((X)=>{console.error("Error reading log file slice:",X)})}catch(J){console.error("Error reading log file:",J)}this.lastSize=M}else if(M<this.lastSize)this.lastSize=M}parseLines(M){let w=[],J=M.split(`
`).filter((Q)=>Q.trim());for(let Q of J)try{let X=JSON.parse(Q);w.push(X)}catch(X){console.error("Failed to parse JSON line:",X)}return w}emit(M){for(let w of this.subscribers)try{w(M)}catch(J){console.error("Subscriber error:",J)}}}import{existsSync as A,readdirSync as D0,statSync as g,readFileSync as z0}from"fs";import{join as y}from"path";class P{interval=null;subscribers=new Set;planCache=new Map;start(){if(this.interval)return;this.scanPlans(),this.interval=setInterval(()=>{this.checkForChanges()},j.POLL_INTERVAL_MS)}stop(){if(this.interval)clearInterval(this.interval),this.interval=null}subscribe(M){return this.subscribers.add(M),()=>this.subscribers.delete(M)}getAllPlans(M=!0){let w=[];if(w.push(...this.scanDirectory(Y.DEV_ACTIVE_DIR,"active")),M){let J=this.scanDirectory(Y.DEV_COMPLETE_DIR,"completed");w.push(...J.slice(0,j.MAX_COMPLETED_PLANS))}return w.sort((J,Q)=>new Date(Q.lastModified).getTime()-new Date(J.lastModified).getTime())}getPlan(M){let w=y(Y.DEV_ACTIVE_DIR,M,"features.json");if(A(w))return this.readPlanData(w);if(w=y(Y.DEV_COMPLETE_DIR,M,"features.json"),A(w))return this.readPlanData(w);return null}scanDirectory(M,w){if(!A(M))return[];let J=[];try{let Q=D0(M,{withFileTypes:!0});for(let X of Q){if(!X.isDirectory())continue;let Z=y(M,X.name,"features.json");if(!A(Z))continue;let $=this.readPlanInfo(Z,X.name,w);if($)J.push($)}}catch(Q){console.error(`Error scanning directory ${M}:`,Q)}return J}readPlanData(M){try{let w=z0(M,"utf-8");return JSON.parse(w)}catch(w){return console.error("Failed to read plan data:",w),null}}readPlanInfo(M,w,J){try{let Q=g(M),X=this.readPlanData(M);if(!X)return null;let Z=X.features||[],$=Z.filter((U)=>U.status==="completed").length,K=Z.filter((U)=>U.status==="in_progress").length,B=Z.filter((U)=>U.status==="failed").length;return{name:w,path:M,project:X.project||w,description:X.description||"",featureCount:Z.length,completedCount:$,inProgressCount:K,failedCount:B,status:J,lastModified:Q.mtime.toISOString()}}catch(Q){return console.error("Failed to read plan info:",Q),null}}scanPlans(){let M=this.getAllPlans();for(let w of M)try{let J=g(w.path);this.planCache.set(w.path,{mtime:J.mtimeMs,data:w})}catch(J){console.error("Failed to stat plan file during initial scan:",J)}}checkForChanges(){let M=this.getAllPlans(),w=new Set;for(let J of M){w.add(J.path);try{let Q=g(J.path),X=this.planCache.get(J.path);if(!X||X.mtime!==Q.mtimeMs)this.planCache.set(J.path,{mtime:Q.mtimeMs,data:J}),this.emit(J)}catch(Q){console.error("Failed to check plan for changes:",Q)}}for(let[J]of this.planCache)if(!w.has(J))this.planCache.delete(J)}emit(M){for(let w of this.subscribers)try{w(M)}catch(J){console.error("Plan subscriber error:",J)}}}import{existsSync as O,readdirSync as o,readFileSync as H}from"fs";import{join as i,basename as n}from"path";class u{async getData(){let[M,w,J,Q,X,Z]=await Promise.all([this.getSessions(),this.getGlobalStats(),this.getCommands(),this.getSkills(),this.getHooks(),this.getMcpServers()]);return{sessions:M,currentSession:process.env[I]||null,globalStats:w,commands:J,hooks:X,skills:Q,mcpServers:Z,lastUpdated:new Date().toISOString()}}async getSessions(){let M=await R.listSessions(),w=Date.now();return M.map((J)=>{let Q=this.readSessionEntries(J.session_id),X=this.findLastActivity(Q),Z=this.determineStatus(Q,X,w),$=this.computeSessionStats(Q);return{...J,status:Z,last_heartbeat:X,tool_call_count:$.toolCalls,message_count:$.messages,compaction_count:$.compactions,started_at:this.findStartTime(Q)}})}readSessionEntries(M){let w=Y.getSessionLogPath(M);if(!O(w))return[];try{return H(w,"utf-8").trim().split(`
`).filter(Boolean).map((Q)=>JSON.parse(Q))}catch(J){return console.debug("[DashboardService] Failed to read session entries:",J),[]}}findLastActivity(M){if(M.length===0)return null;return M[M.length-1]?.timestamp??null}determineStatus(M,w,J){let Q=M.findLastIndex((X)=>X.event==="SessionEnd");if(Q!==-1){if(!M.slice(Q+1).some((Z)=>Z.event==="SessionStart"))return"ended"}if(w){let X=new Date(w).getTime();if(J-X>l.HEARTBEAT_TIMEOUT_MS)return"inactive";return"active"}return"inactive"}computeSessionStats(M){let w=0,J=0,Q=0;for(let X of M)switch(X.event){case"PostToolUse":case"PostToolUseFailure":w++;break;case"UserPromptSubmit":J++;break;case"PreCompact":Q++;break}return{toolCalls:w,messages:J,compactions:Q}}findStartTime(M){return M.find((J)=>J.event==="SessionStart")?.timestamp??null}getGlobalStats(){let M=Y.STATS_CACHE;if(!O(M))return null;try{let w=H(M,"utf-8"),J=JSON.parse(w);return{totalSessions:J.totalSessions||0,totalMessages:J.totalMessages||0,modelUsage:J.modelUsage||{}}}catch(w){return console.debug("[DashboardService] Failed to parse global stats:",w),null}}getCommands(){let M=Y.COMMANDS_DIR;if(!O(M))return[];try{return o(M).filter((J)=>J.endsWith(".md")).map((J)=>{let Q=i(M,J),X=H(Q,"utf-8"),Z=this.parseFrontmatter(X);return{name:n(J,".md"),description:Z.description||"",argumentHint:Z["argument-hint"],filePath:Q}})}catch(w){return console.debug("[DashboardService] Failed to read commands:",w),[]}}getSkills(){let M=Y.SKILLS_DIR;if(!O(M))return[];try{return o(M).filter((J)=>J.endsWith(".md")).map((J)=>{let Q=i(M,J),X=H(Q,"utf-8"),Z=this.parseFrontmatter(X);return{name:Z.name||n(J,".md"),description:Z.description||"",filePath:Q}})}catch(w){return console.debug("[DashboardService] Failed to read skills:",w),[]}}getHooks(){let M=Y.SETTINGS_FILE;if(!O(M))return[];try{let w=H(M,"utf-8"),J=JSON.parse(w),Q=[];if(J.hooks)for(let[X,Z]of Object.entries(J.hooks))for(let $ of Z)for(let K of $.hooks||[])Q.push({eventName:X,matcher:$.matcher||"",command:K.command||""});return Q}catch(w){return console.debug("[DashboardService] Failed to parse hooks config:",w),[]}}getMcpServers(){let M=Y.SETTINGS_FILE;if(!O(M))return[];try{let w=H(M,"utf-8");return JSON.parse(w).enabledMcpjsonServers||[]}catch(w){return console.debug("[DashboardService] Failed to parse MCP servers config:",w),[]}}parseFrontmatter(M){let w=M.match(/^---\n([\s\S]*?)\n---/);if(!w||!w[1])return{};let J={},Q=w[1].split(`
`);for(let X of Q){let Z=X.indexOf(":");if(Z>0){let $=X.slice(0,Z).trim(),K=X.slice(Z+1).trim();if(K.startsWith('"')&&K.endsWith('"')||K.startsWith("'")&&K.endsWith("'"))K=K.slice(1,-1);J[$]=K}}return J}}import{existsSync as b,readdirSync as s,readFileSync as r,statSync as W0,writeFileSync as G0,mkdirSync as V0}from"fs";import{join as E,basename as L0,dirname as x0}from"path";var T=1;class f{claudeProjectsDir;cachePath;cache=null;cacheLoaded=!1;constructor(){this.claudeProjectsDir=E(Y.CLAUDE_HOME,"projects"),this.cachePath=E(Y.LOGS_DIR,"session-summary-cache.json")}async getSummaries(M){if(!this.cacheLoaded)this.loadCache();let w=this.listProjects(),J=[],Q=process.cwd(),X=this.pathToProjectName(Q),Z=M?w.filter((K)=>K===M||K.includes(M)):w,$=!1;for(let K of Z){let{projectSummaries:B,updated:U}=await this.getProjectSessions(K);if(J.push(...B),U)$=!0}if($)this.saveCache();return J.sort((K,B)=>{let U=new Date(K.last_activity).getTime();return new Date(B.last_activity).getTime()-U}),{summaries:J,projects:w,current_project:X,last_updated:new Date().toISOString()}}loadCache(){if(this.cacheLoaded=!0,!b(this.cachePath)){this.cache={version:T,sessions:{},last_updated:new Date().toISOString()};return}try{let M=r(this.cachePath,"utf-8"),w=JSON.parse(M);if(w.version!==T){console.debug("[SessionSummaryService] Cache version mismatch, rebuilding"),this.cache={version:T,sessions:{},last_updated:new Date().toISOString()};return}this.cache=w,console.debug(`[SessionSummaryService] Loaded ${Object.keys(w.sessions).length} cached sessions`)}catch(M){console.debug("[SessionSummaryService] Failed to load cache:",M),this.cache={version:T,sessions:{},last_updated:new Date().toISOString()}}}saveCache(){if(!this.cache)return;try{let M=x0(this.cachePath);if(!b(M))V0(M,{recursive:!0});this.cache.last_updated=new Date().toISOString(),G0(this.cachePath,JSON.stringify(this.cache,null,2)),console.debug(`[SessionSummaryService] Saved ${Object.keys(this.cache.sessions).length} sessions to cache`)}catch(M){console.debug("[SessionSummaryService] Failed to save cache:",M)}}isCacheValid(M,w){if(!this.cache)return!1;let J=this.cache.sessions[M];if(!J)return!1;let{mtimeMs:Q,size:X}=w;return J.file_mtime===Q&&J.file_size===X}listProjects(){if(!b(this.claudeProjectsDir))return[];try{return s(this.claudeProjectsDir,{withFileTypes:!0}).filter((M)=>M.isDirectory()).map((M)=>M.name).sort()}catch(M){return console.error("Failed to list projects:",M),[]}}projectNameToPath(M){if(M.startsWith("-"))return M.replace(/-/g,"/");return M}pathToProjectName(M){return M.replace(/\//g,"-")}async getProjectSessions(M){let w=E(this.claudeProjectsDir,M);if(!b(w))return{projectSummaries:[],updated:!1};let J=[],Q=!1;try{let X=s(w).filter((Z)=>Z.endsWith(".jsonl")&&!Z.startsWith("agent-"));for(let Z of X){let $=E(w,Z);try{let K=W0($);if(this.isCacheValid($,K)){let U=this.cache.sessions[$];J.push(U.summary);continue}let B=await this.parseSessionFile($,M,K);if(B){if(J.push(B),this.cache)this.cache.sessions[$]={summary:B,file_mtime:K.mtimeMs,file_size:K.size,cached_at:new Date().toISOString()},Q=!0}}catch(K){console.debug(`[SessionSummaryService] Error processing ${Z}:`,K)}}}catch(X){console.debug(`[SessionSummaryService] Error reading project ${M}:`,X)}return{projectSummaries:J,updated:Q}}async parseSessionFile(M,w,J){try{let X=r(M,"utf-8").trim().split(`
`).filter(Boolean);if(X.length===0)return null;let Z=L0(M,".jsonl"),$="",K=null,B=null,U=0,V=0,L=0;for(let F of X)try{let D=JSON.parse(F);if(U++,D.timestamp){if(!K)K=D.timestamp;B=D.timestamp}if(!$&&D.type==="user")$=this.extractUserContent(D);if(D.type==="user"&&!this.isToolResponse(D))V++;if(D.type==="assistant"&&D.message?.usage){let k=D.message.usage;L+=(k.input_tokens||0)+(k.output_tokens||0)+(k.cache_read_input_tokens||0)+(k.cache_creation_input_tokens||0)}if(D.type==="summary"&&D.summary&&!$)$=D.summary}catch(D){console.error("Failed to parse session JSON line:",D)}if(!$||V===0)return null;return{session_id:Z,project_path:this.projectNameToPath(w),project_name:w,description:this.truncateDescription($),message_count:U,turn_count:V,last_activity:B||new Date().toISOString(),first_activity:K||new Date().toISOString(),total_tokens:L,file_size:J.size}}catch(Q){return console.debug(`[SessionSummaryService] Error parsing ${M}:`,Q),null}}extractUserContent(M){let w=M.message?.content;if(typeof w==="string")return this.cleanContent(w);if(Array.isArray(w)){for(let J of w)if(J.type==="text"&&J.text)return this.cleanContent(J.text)}return""}cleanContent(M){if(M.startsWith("<command-")||M.startsWith("<local-command-")||M.includes("command-message")||M.trim()==="Warmup"||M.toLowerCase().includes("caveat:")||M.toLowerCase().startsWith("this session is being continued"))return"";return M.replace(/\s+/g," ").trim()}isToolResponse(M){let w=M.message?.content;if(Array.isArray(w)&&w.length>0){let J=w[0];if(typeof J==="object"&&J.type==="tool_result")return!0}return!1}truncateDescription(M,w=200){if(M.length<=w)return M;return M.slice(0,w-3)+"..."}clearCache(){this.cache={version:T,sessions:{},last_updated:new Date().toISOString()},this.saveCache()}}import{randomBytes as k0}from"crypto";function S(M){if(!M||typeof M!=="string")return null;if(M.length>64)return null;if(!/^[a-zA-Z0-9-]+$/.test(M))return null;return M}function a(M){if(!M||typeof M!=="string")return null;let w;try{w=decodeURIComponent(M)}catch{return null}if(w.includes("\x00"))return null;if(w.includes(".."))return null;if(w.includes("/")||w.includes("\\"))return null;if(!w.trim())return null;return w}function t(M,w){let{join:J,resolve:Q,normalize:X}=Z0("path"),Z=X(Q(w)),$=X(Q(w,M));if(!$.startsWith(Z))return null;return $}function _(M){return`http://localhost:${M}`}function e(M){if(!M||typeof M!=="string")return null;let w;try{w=decodeURIComponent(M)}catch{return null}if(w.includes("\x00"))return null;if(!/^[a-zA-Z0-9_-]+$/.test(w))return null;if(w.length>128)return null;return w}function M0(){return k0(32).toString("hex")}function w0(M,w){if(!M)return!1;return M.replace(/^Bearer\s+/i,"")===w}class m{connections=new Map;maxConnections;windowMs;cleanupInterval=null;constructor(M){this.maxConnections=M.maxConnections,this.windowMs=M.windowMs,this.cleanupInterval=setInterval(()=>this.cleanup(),60000)}isAllowed(M){let w=Date.now(),J=this.connections.get(M);if(!J||w-J.windowStart>this.windowMs)return this.connections.set(M,{count:1,windowStart:w}),!0;if(J.count>=this.maxConnections)return!1;return J.count++,!0}cleanup(){let M=Date.now();this.connections.forEach((w,J)=>{if(M-w.windowStart>this.windowMs)this.connections.delete(J)})}stop(){if(this.cleanupInterval)clearInterval(this.cleanupInterval),this.cleanupInterval=null}}var J0={maxConnections:5,windowMs:60000};var Q0=process.env.CLAUDE_HOOKS_VIEWER_TOKEN||M0(),R0={".html":"text/html",".css":"text/css",".js":"application/javascript",".json":"application/json",".svg":"image/svg+xml"},O0=["default-src 'self'","script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com","style-src 'self' 'unsafe-inline' https://fonts.googleapis.com","font-src 'self' https://fonts.gstatic.com","img-src 'self' data:","connect-src 'self'","frame-ancestors 'none'"].join("; "),z=new R;z.start();var H0=new u,x=new P;x.start();var q0=new f,h=new m(J0),v=process.env[I]||null;if(v)z.setSession(v);function C0(M){let w=M.substring(M.lastIndexOf("."));return R0[w]||"application/octet-stream"}async function p(M){let w=Bun.file(M);if(!await w.exists())return new Response("Not Found",{status:404});let J=C0(M),Q={"Content-Type":J};if(J==="text/html")Q["Content-Security-Policy"]=O0,Q["X-Content-Type-Options"]="nosniff",Q["X-Frame-Options"]="DENY";return new Response(w,{headers:Q})}function q(M,w){return`event: ${M}
data: ${JSON.stringify(w)}

`}async function T0(){let w={sessions:await R.listSessions(),current_session:v};return Response.json(w)}function _0(M){let w=new TextEncoder,J=null,Q=null,X=new ReadableStream({start(Z){let $=z.getAllEntries();Z.enqueue(w.encode(q("entries",$))),Q=z.subscribe((K)=>{try{Z.enqueue(w.encode(q("entry",K)))}catch{}}),J=setInterval(()=>{try{let K={type:"heartbeat",timestamp:new Date().toISOString()};Z.enqueue(w.encode(q("heartbeat",K)))}catch{}},N.HEARTBEAT_INTERVAL)},cancel(){if(J)clearInterval(J);if(Q)Q()}});return new Response(X,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive","Access-Control-Allow-Origin":_(G.PORT)}})}function v0(){let M=new TextEncoder,w=null,J=null,Q=new ReadableStream({start(X){let Z=x.getAllPlans();X.enqueue(M.encode(q("plans",Z))),J=x.subscribe(($)=>{try{let K={type:"plan_updated",plan:$,timestamp:new Date().toISOString()};X.enqueue(M.encode(q("plan_update",K)))}catch{}}),w=setInterval(()=>{try{X.enqueue(M.encode(q("heartbeat",{timestamp:new Date().toISOString()})))}catch{}},N.HEARTBEAT_INTERVAL)},cancel(){if(w)clearInterval(w);if(J)J()}});return new Response(Q,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive","Access-Control-Allow-Origin":_(G.PORT)}})}async function F0(M){let w=new URL(M.url),J=w.pathname;if(J==="/"&&M.method==="GET")return p(Y.INDEX_HTML);if(J.startsWith("/styles/")&&M.method==="GET"){let Q=J.replace("/styles/",""),X=a(Q);if(!X)return new Response("Bad Request",{status:400});let Z=t(X,Y.STYLES_DIR);if(!Z)return new Response("Forbidden",{status:403});return p(Z)}if(J==="/logo.svg"&&M.method==="GET")return p(Y.LOGO_SVG);if(J==="/events"&&M.method==="GET"){if(!h.isAllowed("127.0.0.1"))return new Response("Too Many Requests",{status:429,headers:{"Retry-After":"60"}});let X=w.searchParams.get("session"),Z=S(X)||v;if(Z&&Z!==z.getCurrentSessionId())z.setSession(Z);return _0(M)}if(J==="/api/sessions"&&M.method==="GET")return await T0();if(J==="/api/entries"&&M.method==="GET"){let Q=w.searchParams.get("session"),X=S(Q)||v;if(X&&X!==z.getCurrentSessionId())z.setSession(X);let Z=z.getAllEntries();return new Response(JSON.stringify(Z),{headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":_(G.PORT)}})}if(J==="/api/dashboard"&&M.method==="GET")try{let Q=await H0.getData();return Response.json(Q)}catch(Q){return console.error("Dashboard error:",Q),Response.json({error:"Failed to load dashboard data"},{status:500})}if(J==="/api/summaries"&&M.method==="GET")try{let Q=w.searchParams.get("project")||void 0,X=await q0.getSummaries(Q);return Response.json(X)}catch(Q){return console.error("Session summaries error:",Q),Response.json({error:"Failed to load session summaries"},{status:500})}if(J==="/shutdown"&&M.method==="POST"){let Q=M.headers.get("Authorization");if(!w0(Q,Q0))return new Response(JSON.stringify({error:"Unauthorized"}),{status:401,headers:{"Content-Type":"application/json","WWW-Authenticate":"Bearer"}});return console.log(`
\uD83D\uDED1 Shutdown requested via API`),setTimeout(()=>{z.stop(),x.stop(),X0.stop(),process.exit(0)},c.SHUTDOWN_DELAY_MS),new Response(JSON.stringify({status:"shutting_down"}),{headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":_(G.PORT)}})}if(J==="/api/plans"&&M.method==="GET"){let Q=w.searchParams.get("completed")!=="false",X=x.getAllPlans(Q),Z={plans:X,activePlans:X.filter(($)=>$.status==="active").length,completedPlans:X.filter(($)=>$.status==="completed").length};return Response.json(Z)}if(J.startsWith("/api/plans/")&&M.method==="GET"){let Q=J.replace("/api/plans/",""),X=e(Q);if(!X)return Response.json({error:"Invalid plan name"},{status:400});let Z=x.getPlan(X);if(!Z)return Response.json({error:"Plan not found"},{status:404});return Response.json(Z)}if(J==="/events/plans"&&M.method==="GET"){if(!h.isAllowed("127.0.0.1"))return new Response("Too Many Requests",{status:429,headers:{"Retry-After":"60"}});return v0()}return new Response("Not Found",{status:404})}var X0=Bun.serve({port:G.PORT,hostname:G.HOST,fetch:F0,idleTimeout:0});console.log(`\uD83D\uDD0D Hook Viewer running at ${G.URL}`);console.log(`\uD83D\uDD11 Shutdown token: ${Q0}`);process.on("SIGINT",()=>{console.log(`
Shutting down...`),z.stop(),x.stop(),h.stop(),X0.stop(),process.exit(0)});
