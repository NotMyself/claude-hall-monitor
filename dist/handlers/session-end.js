// @bun
import{mkdir as F,appendFile as G}from"fs/promises";import{dirname as J,join as K}from"path";import{fileURLToPath as j}from"url";var Y=J(j(import.meta.url)),V=K(Y,"..","hooks-log.txt"),Z=K(Y,"..","logs");function v(q){return K(Z,`${q}.txt`)}async function D(){try{await F(Z,{recursive:!0})}catch(q){if(q.code!=="EEXIST")throw q}}async function $(q,z,X){await D();let x=v(z),B={timestamp:new Date().toISOString(),event:q,session_id:z,data:X},y=JSON.stringify(B)+`
`;await G(x,y,"utf-8")}async function k(){let q=await Bun.stdin.text();return JSON.parse(q)}function Q(q){console.log(JSON.stringify(q))}var N=3456,U=`http://localhost:${N}`;async function W(){try{let q=new AbortController,z=setTimeout(()=>q.abort(),2000);await fetch(`${U}/shutdown`,{method:"POST",signal:q.signal}),clearTimeout(z),console.error(`
\uD83D\uDED1 Hook Viewer shut down
`)}catch{}}async function b(){let q=await k();if(await $("SessionEnd",q.session_id,{cwd:q.cwd,reason:q.reason,transcript_path:q.transcript_path,permission_mode:q.permission_mode,ended_at:new Date().toISOString()}),q.reason!=="clear"&&q.reason!=="compact")await W();Q({continue:!0})}try{await b()}catch(q){console.error("Handler error:",q),Q({continue:!0}),process.exit(1)}
