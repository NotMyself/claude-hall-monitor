// @bun
var{spawn:M}=globalThis.Bun;import{join as P}from"path";import{mkdir as H,appendFile as D}from"fs/promises";import{dirname as b,join as k}from"path";import{fileURLToPath as N}from"url";var B=b(N(import.meta.url)),h=k(B,"..","hooks-log.txt"),x=k(B,"..","logs");function W(q){return k(x,`${q}.txt`)}async function C(){try{await H(x,{recursive:!0})}catch(q){if(q.code!=="EEXIST")throw q}}async function y(q,Q,X){await C();let Z=W(Q),J={timestamp:new Date().toISOString(),event:q,session_id:Q,data:X},A=JSON.stringify(J)+`
`;await D(Z,A,"utf-8")}async function F(){let q=await Bun.stdin.text();return JSON.parse(q)}function z(q){console.log(JSON.stringify(q))}import{join as K,resolve as Y}from"path";var j={PORT:parseInt(process.env.HOOK_VIEWER_PORT||"3456",10),HOST:process.env.HOOK_VIEWER_HOST||"127.0.0.1",get URL(){return`http://${this.HOST}:${this.PORT}`}},T={VIEWER_DIR:import.meta.dir,LOGS_DIR:Y(import.meta.dir,"..","logs"),getSessionLogPath(q){return K(this.LOGS_DIR,`${q}.txt`)},INDEX_HTML:K(import.meta.dir,"index.html"),STYLES_DIR:K(import.meta.dir,"styles"),LOGO_SVG:K(import.meta.dir,"logo.svg"),CLAUDE_HOME:process.env.USERPROFILE?K(process.env.USERPROFILE,".claude"):K(process.env.HOME||"",".claude"),get STATS_CACHE(){return K(this.CLAUDE_HOME,"stats-cache.json")},COMMANDS_DIR:Y(import.meta.dir,"..","..","commands"),SKILLS_DIR:Y(import.meta.dir,"..","..",".claude","skills"),SETTINGS_FILE:Y(import.meta.dir,"..","..",".claude","settings.json"),PROJECT_ROOT:Y(import.meta.dir,"..",".."),get DEV_ACTIVE_DIR(){return K(this.PROJECT_ROOT,"dev","active")},get DEV_COMPLETE_DIR(){return K(this.PROJECT_ROOT,"dev","complete")},getPlanFeaturesPath(q){return K(q,"features.json")}},G="CLAUDE_HOOKS_VIEWER_SESSION";var U=3456,$=`http://localhost:${U}`;async function f(){try{let q=new AbortController,Q=setTimeout(()=>q.abort(),1000),X=await fetch($,{signal:q.signal});return clearTimeout(Q),X.ok}catch{return!1}}function O(q){return q.replace(/\\/g,"/")}function S(q){let Q=O(P(import.meta.dir,"..","viewer","server.ts"));try{let X=process.platform==="win32"?["powershell","-NoProfile","-Command",`Start-Process -NoNewWindow -FilePath bun -ArgumentList 'run', '${Q}'`]:["sh","-c",`bun run "${Q}" &`];M(X,{env:{...process.env,[G]:q},stdout:"ignore",stderr:"ignore",stdin:"ignore"}).unref(),console.error(`
\uD83D\uDD0D Hook Viewer starting at ${$}
`)}catch(X){console.error("Failed to start viewer:",X)}}async function V(){let q=await F();if(await y("SessionStart",q.session_id,{cwd:q.cwd,source:q.source,transcript_path:q.transcript_path,permission_mode:q.permission_mode,started_at:new Date().toISOString()}),!await f())S(q.session_id);else console.error(`
\uD83D\uDD0D Hook Viewer: ${$}
`);let Z={continue:!0,hookSpecificOutput:{hookEventName:"SessionStart",additionalContext:q.source==="startup"?`Session started. Hook Viewer available at ${$}`:`Session ${q.source} at ${new Date().toISOString()}`}};z(Z)}try{await V()}catch(q){console.error("Handler error:",q),z({continue:!0}),process.exit(1)}
